<%-include("../layout/adminheader.ejs")-%>
<%-include("../layout/admincentre.ejs")-%>

<%-include("../partials/adminnavbar.ejs")-%>
<div class="container" style="margin-top: 90px;">
    <div class="row">
        <div class="col-12 text-center">
            <h1>Edit Product</h1>
        </div>
    </div>
    <form action="/admin/editProducts/<%=product._id%>" method="post" enctype="multipart/form-data">
        <div class="row p-3 d-flex justify-content-center align-items-center shadow-lg mt-4" style="border-radius: 15px;">
            <div class="col-md-6">
                <div class="p-4">
                    <div class="mb-3">
                        <label for="productName">Product Name</label>
                        <input type="text" id="productName" name="productName" class="form-control" placeholder="Product Name" value="<%=product.productName%>" required>
                    </div>
                    <div class="mb-3">
                        <label for="Category">Category</label>
                        <select class="form-select" id="Category" name="Category" >
                            <option value="<%=product.Category.categoryname%>" selected disabled><%=product.Category.categoryname%></option>
                            <% category.forEach(x => { %>
                                <% if (x.categoryname !== product.Category.categoryname) { %>
                                    <option value="<%= x._id%>"><%= x.categoryname %></option>
                                <% } %>
                            <% }) %>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="spec1">Specification 1</label>
                        <textarea name="Specification1" id="spec1" class="form-control" placeholder="Specification1" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="spec2">Specification 2</label>
                        <textarea name="Specification2" id="spec2" class="form-control" placeholder="Specification2" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="spec3">Specification 3</label>
                        <textarea name="Specification3" id="spec3" class="form-control" placeholder="Specification3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="spec4">Specification 4</label>
                        <textarea name="Specification4" id="spec4" class="form-control" placeholder="Specification4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="desc">Description</label>
                        <textarea name="Description" id="desc" class="form-control" placeholder="Description" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="price">Price</label>
                        <input type="number" name="price" id="price" class="form-control" placeholder="Enter the price" value="<%=product.price%>" required>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="p-4">
                    
                    <div class="mb-3">
                        <label for="discountAmount">Discount Amount</label>
                        <input type="number" name="discountAmount" id="discountAmount" class="form-control" placeholder="Discount Amount" value="<%=product.discountAmount%>" required>
                    </div>
                    <div class="mb-3">
                        <label for="stockquantity">Stock</label>
                        <input type="number" name="stockQuantity" id="stockquantity" class="form-control" placeholder="Stock" value="<%=product.stockQuantity%>" required>
                    </div>
                    <div class="mb-3">
                        <label for="tags">Tags</label>
                        <input name="tags" id="tags" class="form-control" placeholder="Tags" value="<%=product.tags%>" required>
                    </div>
                    <div class="mb-3">
                        <label for="imageInput1">Upload Image 1</label>
                        <div class="input-group">
                            <input type="file" name="image1" id="imageInput1" class="form-control" accept="image/*" onchange="change(event,0)" value="/productimages/<%=product?.images[0]?.filename%>">
                            
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="imageInput2">Upload Image 2</label>
                        <div class="input-group">
                            <input type="file" name="image2" id="imageInput2" class="form-control" accept="image/*" onchange="change(event,1)">
                           
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="imageInput3">Upload Image 3</label>
                        <div class="input-group">
                            <input type="file" name="image3" id="imageInput3" class="form-control" accept="image/*" onchange="change(event,2)">
                            
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="imageInput4">Upload Image 4</label>
                        <div class="input-group">
                            <input type="file" name="image4" id="imageInput4" class="form-control" accept="image/*" onchange="change(event,3)">
                            
                        </div>
                    </div>
                    
                    <br>
                    <div class="d-flex justify-content-center">
                        <div style="width: 100px;height: 100px;margin-right: 4%;margin-left: 4%;">
                            <img id="imagePreview1" src="/productimages/<%=product.images[0]%>" alt="Image Preview 1" style="max-width: 100px; max-height: 100px;">
                            <button type="button" onclick="deleteImage('<%=product._id%>','<%=product.images[0]%>')" class="btn btn-danger text-white">Delete</button>
                        </div>
                        <div style="width: 100px;height: 100px;margin-right: 4%;">
                            <img id="imagePreview2" src="/productimages/<%=product.images[1]%>" alt="Image Preview 2" style="max-width: 100px; max-height: 100px;">
                            <button type="button" onclick="deleteImage('<%=product._id%>','<%=product.images[1]%>')" class="btn btn-danger text-white">Delete</button>
                        </div>
                        <div style="width: 100px;height: 100px;margin-right: 4%;">
                            <img id="imagePreview3" src="/productimages/<%=product.images[2]%>" alt="Image Preview 3" style="max-width: 100px; max-height: 100px;">
                            <button type="button" onclick="deleteImage('<%=product._id%>','<%=product.images[2]%>')" class="btn btn-danger text-white">Delete</button>
                        </div>
                        <div style="width: 100px;height: 100px;">
                            <img id="imagePreview4" src="/productimages/<%=product.images[3]%>" alt="Image Preview 4" style="max-width: 100px; max-height: 100px;">
                            <button type="button" onclick="deleteImage('<%=product._id%>','<%=product.images[3]%>')" class="btn btn-danger text-white">Delete</button>
                        </div>

                    </div>
                    
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-12 text-center">
                <button type="submit" class="btn btn-primary">Edit Product</button>
            </div>
        </div>
    </form>
</div>

<script>

function change(event, no) {
    console.log("ok da");
    var fileInput = event.target;
    const filename = fileInput.files[0].name;
    const filenameInput = document.getElementById(`imageInput${no}Filename`);
    filenameInput.value = filename;
    var allowedExtensions = /(\.jpg|\.jpeg|\.png|\.gif)$/i;
    if (!allowedExtensions.exec(fileInput.value)) {
        alert('Please upload only image files (jpg, jpeg, png, gif).');
        fileInput.value = '';
        return false;
    }

    document.getElementById(`imagePreview${no}`).src = URL.createObjectURL(fileInput.files[0]);
    return true;
}


    let spec1 = document.getElementById('spec1');
    spec1.value = '<%=product.Specification1%>'
    let spec2 = document.getElementById('spec2');
    spec2.value = '<%=product.Specification2%>'
    let spec3 = document.getElementById('spec3');
    spec3.value = '<%=product.Specification3%>'
    let spec4 = document.getElementById('spec4');
    spec4.value = '<%=product.Specification4%>'
    let desc = document.getElementById('desc');
    desc.value = '<%=product.Description%>'

    const priceInput = document.getElementById('price');
    const discountInput = document.getElementById('discountAmount');
    const stockInput = document.getElementById("stockquantity")
    const nameInput = document.getElementById("name")
    const spec1Input = document.getElementById('spec1')
    const spec2Input = document.getElementById('spec2')
    const spec3Input = document.getElementById('spec3')
    const spec4Input = document.getElementById('spec4')
    const descInput = document.getElementById('desc')

    priceInput.addEventListener('input', validatePrice);
    discountInput.addEventListener('input', validatePrice);
    stockInput.addEventListener('input', validatestock)
    nameInput.addEventListener('input',validateTrim)
    spec1Input.addEventListener('input',validateTrim)
    spec2Input.addEventListener('input',validateTrim)
    spec3Input.addEventListener('input',validateTrim)
    spec4Input.addEventListener('input',validateTrim)
    descInput.addEventListener('input',validateTrim)


    function validatePrice() {
        const price = parseFloat(priceInput.value);
        const discount = parseFloat(discountInput.value);

        if (price <= discount) {
            priceInput.setCustomValidity('Price must be greater than discount amount.');
        } else if(discount < 0){
            discountInput.setCustomValidity('discount must be more than or equal to zero')
        }else {
            priceInput.setCustomValidity('');
            discountInput.setCustomValidity('');
        }
    }
    function validatestock() {
        const stock = parseFloat(stockInput.value)
        if(stock < 0) stockInput.setCustomValidity('Stock must be more than or equal to zero');
        else stockInput.setCustomValidity('');
    }
    function validateTrim(){
        const name = nameInput.value
        if(name.trim()===""){
            nameInput.setCustomValidity("Fields cannot contain only spaces. Please enter valid values.")
        } else if(!/^[a-zA-Z\s]+$/.test(name)){
            nameInput.setCustomValidity("Fields cannot contain numbers.")
        }
        else if(spec1.value.trim()===""){
            spec1Input.setCustomValidity("Fields cannot contain only spaces. Please enter valid values.")
        }
        else if(spec2.value.trim()===""){
            spec2Input.setCustomValidity("Fields cannot contain only spaces. Please enter valid values.")
        }
        else if(spec3.value.trim()===""){
            spec3Input.setCustomValidity("Fields cannot contain only spaces. Please enter valid values.")
        }
        else if(spec4.value.trim()===""){
            spec4Input.setCustomValidity("Fields cannot contain only spaces. Please enter valid values.")
        }
        else if (desc.value.trim()===""){
            descInput.setCustomValidity("Fields cannot contain only spaces. Please enter valid values.")
        }
        else{
            nameInput.setCustomValidity("")
            spec1Input.setCustomValidity("")
            spec2Input.setCustomValidity("")
            spec3Input.setCustomValidity("")
            spec4Input.setCustomValidity("")
            descInput.setCustomValidity("")
        }
    }

function deleteImage(productId, Index) {
fetch(`/admin/deleteImage/${productId}/${Index}`, {
    method: 'GET'
})
.then(response => response.json())
.then(data => {
    console.log(data, '------------------->');
    if (data.success) {
        alert('Image deleted successfully');
        window.location.reload();
    } else {
        alert('Oops!! Something went wrong');
    }
})
.catch(error => {
    console.error('Error:', error);
    alert('Error occurred while deleting the image');
});
}
</script>
<%-include("../layout/adminfooter.ejs")-%>